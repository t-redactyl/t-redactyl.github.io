<!DOCTYPE html>
<!--[if IEMobile 7]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html
  class="no-js"
  lang="en"
><!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <title>Interactive model decision trees in Stata</title>
    <meta name="author" content="Jodie Burchell" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="description" content="Interactive model decision trees in Stata written September 22, 2015 in stata,programming tips,consulting">
  <meta name="keywords" content="stata, consulting, teaching, programming, data science" />

    <link
      rel="canonical"
      href="https://t-redactyl.github.io/blog/2015/09/interactive-model-decision-trees-in-stata.html"
    />

    <link href="https://t-redactyl.github.io/favicon.png" rel="icon" />

    <link
      href="https://t-redactyl.github.io/feeds/all.atom.xml"
      type="application/atom+xml"
      rel="alternate"
      title="Standard error Full Atom Feed"
    />
      <link
      href="https://t-redactyl.github.io/theme/css/screen.css"
      media="screen, projection"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://t-redactyl.github.io/theme/css/tomorrow.css"
      media="screen, projection"
      rel="stylesheet"
      type="text/css"
    />
     <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <!-- KaTeX for math rendering -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-beta1/katex.min.css"
      integrity="sha384-VEnyslhHLHiYPca9KFkBB3CMeslnM9CzwjxsEbZTeA21JBm7tdLwKoZmCt3cZTYD"
      crossorigin="anonymous"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-beta1/katex.min.js"
      integrity="sha384-O4hpKqcplNCe+jLuBVEXC10Rn1QEqAmX98lKAIFBEDxZI0a+6Z2w2n8AEtQbR4CD"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-beta1/contrib/auto-render.min.js"
      integrity="sha384-IiI65aU9ZYub2MY9zhtKd1H2ps7xxf+eb2YFG9lX6uRqpXCvBTOidPRCXCrQ++Uc"
      crossorigin="anonymous"
    ></script>
   </head>
  <body>
    <a href="/" class="home-icon">
      <img src="https://t-redactyl.github.io/theme/images/home.png" />
    </a>
<article role="article" class="full-single-article">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>Interactive model decision trees in Stata</h1>
        <div class="meta">
          written <time datetime="2015-09-22T00:00:00+02:00">September 22, 2015</time>
          in <span class="categories">
            <a href="https://t-redactyl.github.io/tag/stata.html">stata</a>,            <a href="https://t-redactyl.github.io/tag/programming-tips.html">programming tips</a>,            <a href="https://t-redactyl.github.io/tag/consulting.html">consulting</a>          </span>
        </div>
        <p>When I was doing statistical consulting work in a university&#8217;s medical department, my clients often wanted me to teach them about the analyses I was doing for them, rather than just completing the work and handing it over. In addition, they were usually operating under limited budgets so wanted to do at least some of the work themselves to save&nbsp;money.</p>
<p>This was a bit of a problem when I needed to use fairly high-level statistics to model their data. In order to allow clients to do this sort of modelling work on their own, I designed a decision tree in <a href="http://www.stata.com">Stata</a> that helped them evaluate a series of models to reach the most suitable&nbsp;one.</p>
<h2>A brief&nbsp;background</h2>
<p>This all started when I was asked to do some analyses for a client who was doing a Ph.D. in immunology, who came to me with a pretty complicated dataset. She was trying to find out whether two groups of patients with hepatitis C had different levels of biomarkers. She had measured the biomarkers at different time points within the same person, and also had a bunch of different biomarker outcomes she wanted to evaluate. <a href="https://en.wikipedia.org/wiki/Multilevel_model">Multilevel models</a> (with random intercepts) were likely the most appropriate model for most of the outcomes, and the graphs demonstrated that time might have a <a href="https://en.wikipedia.org/wiki/Nonlinear_regression">curvilinear relationship</a> with some of the outcomes. These sorts of statistics were beyond the knowledge of my client, but she had so many outcomes she would need to do a lot of this model selection work&nbsp;herself. </p>
<p>In order to allow her to complete this work, I handed the data over to her with the decision-tree function described below (after doing the initial data cleaning, visualisations and testing for some of the&nbsp;assumptions).</p>
<h2>What does the function&nbsp;do?</h2>
<p>The function presents the user with several decision points in building a model, with clear instructions on how to evaluate the output they have been given. It allows them to input each decision on the Stata command line using simple y/n answers. Finally, it presents them with the final model and a brief explanation of what this&nbsp;is.</p>
<h2>A demonstration of the&nbsp;function</h2>
<p>There are several components to the&nbsp;function: </p>
<p><strong>The models that the user needs to evaluate.</strong> In the case of this decision-tree, one choice is between a random-intercepts multilevel model (with &#8220;subj&#8221; as the Level 2 variable) and a regression model with <a href="https://en.wikipedia.org/wiki/Robust_regression">robust standard errors</a> clustered by &#8220;subj&#8221;, and the other choice is between including a quadratic term for time or excluding it (don&#8217;t worry if you don&#8217;t fully understand what these are, the important part is understanding the function itself!). For example, this is one of the&nbsp;models:</p>
<pre><code>xtmixed time i.group || subj: , var mle
</code></pre>
<p><strong>The ability for the function to take user input using the &#8220;_request&#8221; command.</strong> This command assigns the user input to a local which the function can use. For&nbsp;example:</p>
<pre><code>di "Enter a value below in the 'command' window (y/n)" _request(_answer1)
</code></pre>
<p><strong><a href="https://en.wikipedia.org/wiki/Conditional_(computer_programming)">Conditional statements</a> (if, else) that guide the client through the decision-making tree.</strong> These conditional statements evaluate the locals generated by the user input. For&nbsp;example:</p>
<pre><code>if ("" == "y") {               
    xtmixed  time time_sq i.group || subj: , var mle
}
</code></pre>
<p>To demonstrate the function, I will use an example dataset (as my client&#8217;s data contains pretty sensitive medical information!). This is a dataset I sourced from <a href="http://www.ats.ucla.edu/stat/stata/library/gee.htm"><span class="caps">IDRE</span> at <span class="caps">UCLA</span></a>, which is an incredible statistics and statistical programming resource that has particularly good documentation for&nbsp;Stata.</p>
<p>This dataset contains depression scores for 61 participants in two different treatment groups (27 in the placebo and 34 in the estrogen treatment). Each participant was assessed at baseline (pre) and at 6 timepoints&nbsp;thereafter.</p>
<p>The depression scores are currently in a <strong>wide</strong> format, with a variable for each timepoint. As we are doing regression analyses, we&#8217;ll need all the depression scores in a single variable, therefore we&#8217;ll convert the data to a <strong>long</strong>&nbsp;format.</p>
<pre><code>  use http://www.ats.ucla.edu/stat/stata/library/depress, clear
  reshape long dep, i(subj)
  (note: j = 1 2 3 4 5 6)

  Data                               wide   -&gt;   long
  -----------------------------------------------------------------------------
  Number of obs.                       61   -&gt;     366
  Number of variables                   9   -&gt;       5
  j variable (6 values)                     -&gt;   _j
  xij variables:
                       dep1 dep2 ... dep6   -&gt;   dep
  -----------------------------------------------------------------------------

  rename _j time
  drop pre
</code></pre>
<p>Let&#8217;s now visualise the data to get an idea of how the two groups&#8217; scores behave over&nbsp;time:</p>
<pre><code>  twoway /// 
    (lowess dep time if group == 0, lcolor("169 204 6") lwidth(thick)) /// 
    (lowess dep time if group == 1, lcolor("84 102 3") lwidth(thick)), /// 
    title("Depression Scores Over Time") /// 
    ytitle("Depression scores", size(medsmall)) ///
    xtitle("Time") /// 
    graphregion(color(white)) /// 
    legend(cols(2) ///
        label(1 "Placebo") /// 
        label(2 "Estrogen"))
</code></pre>
<p><img alt="plot of lowess_graph_stata" src="/figure/lowess_graph_stata.png"></p>
<p>The relationship between time and depression seems linear for both groups, but I will keep the quadratic decision-making step in the function for now. Let&#8217;s generate the quadratic term for&nbsp;time:</p>
<pre><code>  gen time_sq = time ^ 2
</code></pre>
<p>Now we run the function&nbsp;below:</p>
<pre><code>capture program drop model_decision
    program model_decision
    args outcome

    xtmixed `outcome' time i.group || subj: , var mle

    di _newline(1)
    di "Step 1: Evaluate initial model." _newline(2) ///
        "Look at the bottom of the output where it reads: 'LR test vs. linear regression...Prob &gt;= chibar2 ='" _newline(1) ///
        "Does 'Prob &gt;= chibar2' have a value of &lt; .05? " _newline(2) /// 
        "Enter a value below in the 'command' window (y/n)" _request(_answer1)

    if ("`answer1'" == "y") {

        xtmixed `outcome' time time_sq i.group || subj: , var mle

        di _newline(2) ///
            "Step 2: Now look at the row of the first table labelled 'time_sq'." _newline(1) ///
            "Is this variable significant? "  _newline(2) ///
            "Enter a value below in the 'command' window (y/n)" _request(_answer2)
            di _newline(2)

        }

    else if ("`answer1'" == "n") {

        regress `outcome' time time_sq i.group, vce(cluster id)

        di _newline(2) ///   
            "Step 2: Now look at the row of the table labelled 'time_sq'." _newline(1) ///
            "Is this variable significant? " _newline(2) ///
            "Enter a value below in the 'command' window (y/n)" _request(_answer3)
            di _newline(2)

        }

    if ("`answer2'" == "y") {
        di _newline(2) ///
        "The final model for `outcome' is below. " ///
        "This is a random-intercepts multilevel model with a quadratic term."
        di _newline(1)

        xtmixed `outcome' time time_sq i.group || subj: , var mle

        }

    else if ("`answer2'" == "n") {
        di _newline(2) ///
        "The final model for `outcome' is below. " ///
        "This is a random-intercepts multilevel model."
        di _newline(1)

        xtmixed `outcome' time i.group || subj: , var mle

        }

    if ("`answer3'" == "y") {
        di _newline(2) ///
        "The final model for `outcome' is below. " ///
        "This is a linear regression with a quadratic term which has robust standard errors clustered by ID."
        di _newline(1)

        regress `outcome' time time_sq i.group, vce(cluster id)

        }

    else if ("`answer3'" == "n") {
        di _newline(2) ///
        "The final model for `outcome' is below. " ///
        "This is a linear regression which has robust standard errors clustered by ID."
        di _newline(1)

        regress `outcome' time time_sq i.group, vce(cluster id)

        }
end
</code></pre>
<p>Once you have everything set up as above, it is simple! We just get the user to call the&nbsp;function:</p>
<pre><code>model_decision dep
</code></pre>
<p>The output that the user sees is shown below, but I recommend you run the function yourself within Stata to see how the user will actually interact with the&nbsp;program.</p>
<pre><code>  Performing EM optimization:

  Performing gradient-based optimization:

  Iteration 0:   log likelihood = -836.98669  
  Iteration 1:   log likelihood = -836.98669

  Computing standard errors:

  Mixed-effects ML regression                     Number of obs      =       295
  Group variable: subj                            Number of groups   =        61

                                                  Obs per group: min =         1
                                                                 avg =       4.8
                                                                 max =         6


                                                  Wald chi2(2)       =    122.49
  Log likelihood = -836.98669                     Prob &gt; chi2        =    0.0000

  ------------------------------------------------------------------------------
           dep |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
  -------------+----------------------------------------------------------------
          time |   -1.22265   .1169081   -10.46   0.000    -1.451785    -.993514
               |
         group |
     estrogen  |  -3.780498   1.174419    -3.22   0.001    -6.082316   -1.478679
         _cons |   17.97587   .9454841    19.01   0.000     16.12276    19.82899
  ------------------------------------------------------------------------------

  ------------------------------------------------------------------------------
    Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
  -----------------------------+------------------------------------------------
  subj: Identity               |
                    var(_cons) |   17.42846   3.696099      11.50118    26.41044
  -----------------------------+------------------------------------------------
                 var(Residual) |   11.19347   1.031967      9.343066    13.41035
  ------------------------------------------------------------------------------
  LR test vs. linear regression: chibar2(01) =   152.15 Prob &gt;= chibar2 = 0.0000


  Step 1: Evaluate initial model.

  Look at the bottom of the output where it reads: 'LR test vs. linear regression...Prob &gt;= chibar2 ='
  Does 'Prob &gt;= chibar2' have a value of &lt; .05?

  Enter a value below in the 'command' window (y/n). y

  Performing EM optimization:

  Performing gradient-based optimization:

  Iteration 0:   log likelihood = -836.40586  
  Iteration 1:   log likelihood = -836.40586

  Computing standard errors:

  Mixed-effects ML regression                     Number of obs      =       295
  Group variable: subj                            Number of groups   =        61

                                                  Obs per group: min =         1
                                                                 avg =       4.8
                                                                 max =         6


                                                  Wald chi2(3)       =    124.14
  Log likelihood = -836.40586                     Prob &gt; chi2        =    0.0000

  ------------------------------------------------------------------------------
           dep |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
  -------------+----------------------------------------------------------------
          time |  -1.814816   .5610959    -3.23   0.001    -2.914544   -.7150883
       time_sq |   .0852873   .0790511     1.08   0.281      -.06965    .2402246
               |
         group |
     estrogen  |  -3.747568   1.171837    -3.20   0.001    -6.044326   -1.450811
         _cons |   18.69979   1.157469    16.16   0.000     16.43119    20.96839
  ------------------------------------------------------------------------------

  ------------------------------------------------------------------------------
    Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
  -----------------------------+------------------------------------------------
  subj: Identity               |
                    var(_cons) |   17.33573   3.674356      11.44268    26.26375
  -----------------------------+------------------------------------------------
                 var(Residual) |   11.15279   1.028017      9.309431    13.36114
  ------------------------------------------------------------------------------
  LR test vs. linear regression: chibar2(01) =   152.44 Prob &gt;= chibar2 = 0.0000


  Step 2: Now look at the row of the first table labelled 'time_sq'.
  Is this variable significant?

  Enter a value below in the 'command' window (y/n). n

  The final model for dep is below. This is a random-intercepts multilevel model.

  Performing EM optimization:

  Performing gradient-based optimization:

  Iteration 0:   log likelihood = -836.98669  
  Iteration 1:   log likelihood = -836.98669

  Computing standard errors:

  Mixed-effects ML regression                     Number of obs      =       295
  Group variable: subj                            Number of groups   =        61

                                                  Obs per group: min =         1
                                                                 avg =       4.8
                                                                 max =         6


                                                  Wald chi2(2)       =    122.49
  Log likelihood = -836.98669                     Prob &gt; chi2        =    0.0000

  ------------------------------------------------------------------------------
           dep |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
  -------------+----------------------------------------------------------------
          time |   -1.22265   .1169081   -10.46   0.000    -1.451785    -.993514
               |
         group |
     estrogen  |  -3.780498   1.174419    -3.22   0.001    -6.082316   -1.478679
         _cons |   17.97587   .9454841    19.01   0.000     16.12276    19.82899
  ------------------------------------------------------------------------------

  ------------------------------------------------------------------------------
    Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
  -----------------------------+------------------------------------------------
  subj: Identity               |
                    var(_cons) |   17.42846   3.696099      11.50118    26.41044
  -----------------------------+------------------------------------------------
                 var(Residual) |   11.19347   1.031967      9.343066    13.41035
  ------------------------------------------------------------------------------
  LR test vs. linear regression: chibar2(01) =   152.15 Prob &gt;= chibar2 = 0.0000
</code></pre>
<h2>The take away&nbsp;message</h2>
<p>I hope this program has given you some ideas for teaching clients or students about model building. The function can be easily adapted to any decision-making process where the user can easily choose between models on the basis of the output. It is also obviously not limited to two decision points - you can have as many as you can reasonably keep track of (although it will get confusing pretty fast as the number of decision points increases&#8230;). The code for this post is located in this <a href="https://gist.github.com/t-redactyl/2e31fc12a66d4a5e9f8b">gist on my Github page</a>.</p>
<p>This post was written in Stata using <a href="http://www.haghish.com/statistics/stata-blog/reproducible-research/dynamic_documents/markdown.php#fn3">MarkDoc</a>, which was developed by the talented <span class="caps">E. F.</span>&nbsp;Haghish.</p>
        <hr class="divider-short"/>
        <!-- Disqus goes here -->
        <!-- <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite">Disqus goes here</div>
        </section>
        -->
      </div>
    </div>
  </div>
</article>
    <footer id="footer" class="her-row">
      <div class="container">
        <div class="row">
          <div class="col-md-1">
            <a href="/"><h4>Home</h4></a>
          </div>

          <div class="col-md-2">
            <div class="social-icon-list">
              <a href="https://twitter.com/t_redactyl"
                ><img
                  src="https://t-redactyl.github.io/theme/images/glyphicons_social_31_twitter.png"
              /></a>
               <a href="https://github.com/t-redactyl"
                ><img
                  src="https://t-redactyl.github.io/theme/images/glyphicons_social_21_github.png"
              /></a>
              </div>
          </div>
          <div class="pull-right">
            <h4>
              Powered by <a href="http://blog.getpelican.com/">Pelican</a>.
              Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.
              Title picture by
              <a
                href="https://pixabay.com/en/brandenburg-gate-berlin-landmark-2010656/"
                >Couleur via Pixabay</a
              >.
            </h4>
          </div>
        </div>
      </div>
    </footer>

    <!-- KaTeX rendering -->
    <script>
      renderMathInElement(document.body);
    </script>

 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66946155-1', 'auto');
  ga('send', 'pageview');

</script>    </body>
</html>